---
title: cocos2dx热更新机制
comments: true
date: 2017-01-04 18:55:04
tags:
- cocos2dx
categories:
- cocos2dx
---

游戏脚本资源配置的更新，可以在游戏启动的时候，或者在游戏内更新。cocos2dx更新需要注意的是Lua文件的重新加载问题和纹理的重新加载的问题，纹理的加载需要注意合图文件的plist重新加载.游戏内更新需要注意的是更多需要小心处理精灵帧缓存纹理缓存和动画缓存

#### 基本原理
热更新实现了项目资源和脚本文件的动态更新。当工程有新的改动时，用户无需重新下载完整的安装包，而是通过对比本地与最新的版本信息，仅下载有改动的文件到本地，完成版本的更新。cocos2dx3.10前版本存在问题后续经过改善基本没有问题。

 #### 具体实现

工程的资源和脚本文件存放分2个地方，一个是安装目录，一个是数据目录，当app安装完后，安装目录则不再可写，此后所有的更新文件统一存放到数据目录当中，APP调用文件时，也优先搜索数据目录的文件，当数据目录中找不到文件时，再到安装目录中搜索。

配置文件分2种，project.manifest和version.manifest。服务器和客户端都存有备份，服务器存放着最新的版本配置文件，版本号最高，客户端每次启动前都会将服务器版本文件下载下来，并和本地配置文件对行对比，如果不是最新版本，则下载并安装补丁包。配置文件内容都是Json对象，且结构一样，只是version.manifest只存储了版本信息，project.manifest存储了版本信息和补丁信息。

project.manifest文件结构如下：

```
{
     "packageUrl" :"xxxxx",
     "remoteManifestUrl" :"xxxxx/project.manifest",
     "remoteVersionUrl" :"xxxxx/version.manifest",
     "minVersion":"1.0.0.0",
     "version" : "1.0.0.1",
     "assets" : {
            "images.zip" : {"md5" : "xxxxxx","compressed" : true }
     },

     "searchPaths" :["res","src"]
}
```
- packageUrl表示服务器下载目录的根目录
- remoteManifestUrl字段表示project.manifest文件的下载url
- remoteVersionUrl字段表示version.manifest的下载url
- minVersion 表示支持更新的最低版本，低于该版本则提示重新下载安装包。version字段表示工程的当前版本（如果配置文件是服务器上的，表示服务器的当前版本，如果是客户端的，则表示客户端的当前版本）
- Assets字段表示要更新的资源列表，p1.zip为补丁包名（包全路径为xxxxx/p1.zip），md5字段为该补丁包的唯一标识，compressed表示下载完后是否需解压。
- searchPaths表示要添加的搜索路径（。
- Version.manifest文件结构与上同，但是没有assets字段。


####  更新流程

1. 构造AssetsManagerEx对象
  绑定下载成功、失败、进度的回调函数
  设置下载文件的存放路径
  加载本地project.manifest文件，若失败，则抛出消息ERROR_NO_LOCAL_MANIFEST，结束。

2. 下载version.manifest启动更新

下载version.manifest文件，若成功goto 3，否则下载project.manifest，若成功goto3，否则抛出ERROR_DOWNLOAD_MANIFEST，结束。

3. 版本比较
  加载下载的配置文件并与本地project.manifest版本号进行对比，
  若版本相同，则抛出消息ALREADY_UP_TO_DATE，结束。
  若版本低于可更新版本号，则抛出NONUPDATABLE_VERSION，提示下载完整安装包，结束。
  否则下载project.manifest加载下载的配置文件并与本地project.manifest版本号进行对比，
  若版本相同，则抛出消息ALREADY_UP_TO_DATE，结束。
  若版本低于可更新版本号，则抛出NONUPDATABLE_VERSION，提示下载完整安装包.

4. 下载补丁包
  清空下载记录，下载失败记录，解压记录
  查看是否有未完成的下载记录，有则继续逐个下载（通过查看.temp文件）
  获取本地assets和服务器asset差异列表，根据补丁包名：
  a.如果本地有，服务器没有，则删除，
  b.如果本地有，服务器也有，但md5不同，刚更新,
  c.如果服务器有，本地没有，则添加

5. 解压删除
  依次解压列表中的文件。删除补丁包。结束。

#### 流程图如下所示
![assetmanagerex](https://img-blog.csdnimg.cn/20190107150910349.png)

#### 热更新时机
热更新一般在进入游戏之前也就是登录模块之后，也有放在登录模块之前.
需要确定好那些文件可以热更尤其是在执行热更新时有些已经加载的lua文件，再次require的时候不会重新加载，更新主要有两种情况，第一种是游戏启动更新，第二种是游戏内更新.
##### 游戏启动更新
全局基础的更新，此时需要注意框架层是否更新本次是否立即生效，更新之后可能需要对一些lua文件和游戏纹理资源配置资源重新加载，在重新加载纹理的时候需要尤其你注意
#### 游戏内更新
对于有些游戏需要在游戏内下载子游戏包，此时需要做的是，每次退出子游戏需要全部清理掉纹理和lua资源，负责返回更新会导致更新不立即生效的问题