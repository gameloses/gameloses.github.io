---
title: lua调用so
comments: true
date: 2018-12-11 11:49:06
tags:
- lua
categories:
- lua
excerpt: lua5.1和lua5.3调用调用动态库里的函数的方法,动态库的制作方法.luaL_openlib和luaL_newlibtable、lua_setfuncs构建动态库的方法,通过lua_toXXXX和lua_pushXXX从lua_state中取出放入参数实现参数返回值传递（c<>lua）,lua_state实现了c和lua的通信机制
---

# lua5.1动态库

## c so
```
#include <stdio.h>
#include "./src/lua.h"
#include "./src/lualib.h"
#include "./src/lauxlib.h"

static int add(lua_State *L)
{
    int a,b,c;
    a = lua_tonumber(L,1);
    b = lua_tonumber(L,2);
    c = a+b;
    lua_pushnumber(L,c);
    printf("test hello!!!\r\n");
    return 1;
}

static const struct luaL_Reg lib[] =
{
    {"testadd", add},
    {NULL,NULL}
};

int luaopen_testlib_core(lua_State *L)  // 注意这里的函数写法
{
    //luaL_register(L,"testlib",lib);   // 1
    luaL_openlib(L,"testlib",lib,0);    // 2
    return 1;
}
```


## lua调用脚本
```
require("testlib.core")    // 注意这里的调用,和上面的函数写法是相关联的
c = testlib.testadd(15,25)
print("The result is ",c);
```

# lua5.3

## c so

```
static int
lnow(lua_State *L) {
	uint64_t ti = skynet_now();
	lua_pushinteger(L, ti);
	return 1;
}

int
luaopen_skynet_core(lua_State *L) {
	luaL_checkversion(L);

	luaL_Reg l[] = {
		{ "send" , lsend },
		{ "genid", lgenid },
		{ "redirect", lredirect },
		{ "command" , lcommand },
		{ "intcommand", lintcommand },
		{ "error", lerror },
		{ "tostring", ltostring },
		{ "harbor", lharbor },
		{ "pack", luaseri_pack },
		{ "unpack", luaseri_unpack },
		{ "packstring", lpackstring },
		{ "trash" , ltrash },
		{ "callback", lcallback },
		{ "now", lnow },
		{ NULL, NULL },
	};

	luaL_newlibtable(L, l);

	lua_getfield(L, LUA_REGISTRYINDEX, "skynet_context");
	struct skynet_context *ctx = lua_touserdata(L,-1);
	if (ctx == NULL) {
		return luaL_error(L, "Init skynet context first");
	}

	luaL_setfuncs(L,l,1);

	return 1;
}

```

编译so直接
`local c = require "skynet.core"`